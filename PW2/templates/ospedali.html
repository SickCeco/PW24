{% extends 'base.html' %}
{% block content %}
<!DOCTYPE HTML>
<html>
    <head>
        <title>Ospedale</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/styles.css' %}">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <link rel="shortcut icon" href="{% static 'img/GOOFY_HOSPITAL__1_.png' %}" />
    </head>
    <body id="wholePage">
        <div class="container mt-4">
            <div id="search-filter" class="mb-4">
                <div id="operation-selection" class="btn-group">
                    <button class="button" onclick="selectOperation('select');"><span>Cerca &#128269</span></button>
                    <button class="button" onclick="selectOperation('insert'); resettaContent()"><span>Inserisci ➕</span></button>
                </div>
                <br>
                <div id="filters" class="mt-3">
                    <div class="filter select" style="display: none;">
                        <form id="form_ospedale" class="form-inline" action="{% url 'ospedali' %}" method="post">
                            {% csrf_token %}
                            <button type="button" class="button" onclick="resetFormO()"><span class="reset">Reset &#128260</span></button>
                            <input type="hidden" name="operation" value="select">
                            <input type="text" id="filtro_codice" value="{{ filtro_codice }}" placeholder="Codice Ospedale" name="filtro_codice" pattern="OSP\d{2}" class="form-control mx-2" title="Il codice deve essere nel formato OSP seguito da due cifre.">
                            <input type="text" id="filtro_nome" value="{{ filtro_nome }}" placeholder="Nome" name="filtro_nome" pattern="[A-Za-zÀ-ÿ\s]+" class="form-control mx-2" title="Solo lettere e spazi sono permessi">
                            <input type="text" id="filtro_citta" value="{{ filtro_citta }}" placeholder="Città" name="filtro_citta" pattern="[A-Za-zÀ-ÿ\s]+" class="form-control mx-2" title="Solo lettere e spazi sono permessi">
                            <input type="text" id="filtro_indirizzo" value="{{ filtro_indirizzo }}" placeholder="Indirizzo" name="filtro_indirizzo" pattern="^[A-Za-z\s]+,\s\d+$" class="form-control mx-2" title="L'indirizzo deve essere nel formato 'Nome della Via, Numero Civico'.">
                            <div id="union_button_input_direttore_select" class="input-group mx-2">
                                <button type="button" class="button" onclick="showAllChoiceDirettore('select')"><span id="span_cerca_direttore">Direttore</span></button>
                                <input type="text" style="display:none" id="filtro_direttoreSanitario" value="{{ filtro_direttoreSanitario }}" placeholder="Direttore Sanitario" name="filtro_direttoreSanitario" class="form-control">
                            </div>
                            <button type="submit" class="button"><span>Esegui</span></button>
                        </form>
                    </div>

                    <div class="filter insert" style="display: none;">
                        <form id="form_ospedale" class="form-inline" action="{% url 'ospedali' %}" method="post" onsubmit="return validateForm()">
                            {% csrf_token %}
                            <button type="button" class="button" onclick="resetFormO()"><span class="reset">Reset &#128260</span></button>
                            <input type="hidden" name="operation" value="insert">
                            <input type="text" id="filtro_nome_new" value="{{ filtro_nome_new }}" placeholder="Nome" name="filtro_nome" pattern="[A-Za-zÀ-ÿ\s]+" class="form-control mx-2" title="Solo lettere e spazi sono permessi" required>
                            <input type="text" id="filtro_citta_new" value="{{ filtro_citta_new }}" placeholder="Città" name="filtro_citta" pattern="[A-Za-zÀ-ÿ\s]+" class="form-control mx-2" title="Solo lettere e spazi sono permessi" required>
                            <input type="text" id="filtro_indirizzo_new" value="{{ filtro_indirizzo_new }}" placeholder="Indirizzo" name="filtro_indirizzo" pattern="^[A-Za-z\s]+,\s\d+$" class="form-control mx-2" title="L'indirizzo deve essere nel formato 'Nome della Via, Numero Civico'." required>
                            <div id="union_button_input_direttore_insert" class="input-group mx-2">
                                <button type="button" class="botton" onclick="showChoiceDirettore('insert')"><span id="span_cerca_direttore">Direttore</span></button>
                                <input style="display:none" type="text" id="filtro_direttoreSanitario_new" value="{{ filtro_direttoreSanitario_new }}" placeholder="Scegli il direttore" name="filtro_direttoreSanitario" class="form-control" required readonly>
                            </div>
                            <button type="submit" class="button"><span>Esegui</span></button>    
                        </form>
                    </div>
                    
                </div>
            </div>

            <div id="content">
                {% if success_message %}
                    <div class="alert alert-success" role="alert">
                        {{ success_message }}
                    </div>
                {% elif error_message %}
                    <div class="alert alert-danger" role="alert">
                        {{ error_message }}
                    </div>
                {% endif %}

                <div id="divTable" class="table-responsive">
                    <table class="table table-bordered table-striped">
                        <thead class="head">
                            <tr>
                                <th onclick="sortTable(0)">Codice ↕</th>
                                <th onclick="sortTable(1)">Nome ↕</th>
                                <th onclick="sortTable(2)">Città ↕</th>
                                <th onclick="sortTable(3)">Indirizzo ↕</th>
                                <th colspan="2">Direttore Sanitario</th>
                                <th>Modifica</th>
                                <th>Elimina</th>
                            </tr>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th onclick="sortTable(4)">Codice ↕</th>
                                <th onclick="sortTable(5)">Nome ↕</th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in result %}
                            <tr>
                                <td>{{ row.Codice }}</td>
                                <td>{{ row.Nome }}</td>
                                <td>{{ row.Citta }}</td>
                                <td>{{ row.Indirizzo }}</td>
                                <td><a href="{% url 'cittadino' %}?filtro_cssn={{ row.DirettoreSanitarioCSSN }}">
                                    {{ row.DirettoreSanitarioCSSN }}
                                </a></td>
                                <td>{{ row.DirettoreSanitarioNome }}</td>
                                <td><button class="button" onclick="showUpdate('{{ row.Codice }}')" id="actions"><span>&#128397</span></button></td>
                                <td><button class="button" onclick="showConfirmation('{{ row.Codice }}')" id="actions"><span>&#128465</span></button></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="confirmationModal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Conferma Eliminazione</h5>
                            <button type="button" class="button" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>Sei sicuro di voler eliminare questo elemento?<br>Così facendo eliminerai anche i ricoveri associati a questo ospedale!</p>
                        </div>
                        <div class="modal-footer">
                            <form id="form_ospedale_delete" action="{% url 'ospedali' %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="operation" value="delete">
                                <input type="hidden" id="codice_delete" name="codice_delete" value="">
                                <button type="button" class="button" data-dismiss="modal">Annulla</button>
                                <button type="submit" class="button">Elimina</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="updateModal" class="modal fade" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Modifica Ospedale</h5>
                            <button type="button" class="button" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="form_ospedale_update" action="{% url 'ospedali' %}" method="post" onsubmit="return validateUpdateForm()">
                                {% csrf_token %}
                                <input type="hidden" name="operation" value="update">
                                <input type="hidden" id="codice_update" name="codice_update" value="">
                                <div class="form-group">
                                    <label for="nome_update">Nome:</label>
                                    <input type="text" id="nome_update" name="nome_update" class="form-control" pattern="[A-Za-zÀ-ÿ\s]+" required>
                                </div>
                                <div class="form-group">
                                    <label for="citta_update">Città:</label>
                                    <input type="text" id="citta_update" name="citta_update" class="form-control" pattern="[A-Za-zÀ-ÿ\s]+" required>
                                </div>
                                <div class="form-group">
                                    <label for="indirizzo_update">Indirizzo:</label>
                                    <input type="text" id="indirizzo_update" name="indirizzo_update" class="form-control" pattern="^[A-Za-z\s]+,\s\d+$" required>
                                </div>
                                <div class="form-group">
                                    <label for="direttoreSanitario_update">Direttore Sanitario:</label>
                                    <input type="text" id="direttoreSanitario_update" name="direttoreSanitario_update" class="form-control" readonly required>
                                </div>
                                <button type="submit" class="button">Salva modifiche</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <script>
            function selectOperation(operation) {
                document.querySelectorAll('.filter').forEach(function(filter) {
                    filter.style.display = 'none';
                });
                document.querySelector('.filter.' + operation).style.display = 'block';
            }

            function showAllChoiceDirettore(operation) {
                if (operation === 'select') {
                    document.getElementById('filtro_direttoreSanitario').style.display = 'block';
                } else {
                    document.getElementById('filtro_direttoreSanitario_new').style.display = 'block';
                }
            }

            function showChoiceDirettore(operation) {
                if (operation === 'insert') {
                    document.getElementById('filtro_direttoreSanitario_new').style.display = 'block';
                }
            }

            function showConfirmation(codice) {
                $('#codice_delete').val(codice);
                $('#confirmationModal').modal('show');
            }

            function showUpdate(codice) {
                $('#codice_update').val(codice);
                $('#updateModal').modal('show');
            }

            function validateForm() {
                // Implement form validation logic if needed
                return true;
            }

            function validateUpdateForm() {
                // Implement form validation logic if needed
                return true;
            }

            function resetFormO() {
                document.getElementById('form_ospedale').reset();
            }

            function sortTable(n) {
                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                table = document.querySelector("table");
                switching = true;
                dir = "asc"; 
                while (switching) {
                    switching = false;
                    rows = table.rows;
                    for (i = 1; i < (rows.length - 1); i++) {
                        shouldSwitch = false;
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        if (dir == "asc") {
                            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        } else if (dir == "desc") {
                            if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                    if (shouldSwitch) {
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        switchcount ++; 
                    } else {
                        if (switchcount == 0 && dir == "asc") {
                            dir = "desc";
                            switching = true;
                        }
                    }
                }
            }
        </script>
    </body>
</html>
{% endblock %}
